<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrantFinder — Sheets & Email (Client OAuth)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js" defer></script>

  <meta name="description" content="GrantFinder MVP with Google Sheets + Gmail (OAuth) and OpenAI draft generation (client-side API key entry)." />
  <style> pre { white-space: pre-wrap; }</style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-pink-500 flex items-center justify-center text-white font-bold">GF</div>
        <div>
          <h1 class="text-lg font-semibold">GrantFinder — Sheets & Email</h1>
          <p class="text-sm text-slate-500">Search → Save to Google Sheet → Email → Generate drafts (OpenAI)</p>
        </div>
      </div>
      <nav class="space-x-4 text-sm text-slate-600">
        <button id="gSignBtn" class="px-3 py-1 border rounded text-sm">Sign in with Google</button>
        <button id="gSignOutBtn" class="px-3 py-1 border rounded text-sm hidden">Sign out</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">

    <!-- Search + Results -->
    <section class="bg-white rounded-2xl p-6 shadow-sm mb-6">
      <h2 class="text-xl font-semibold mb-2">Discover Grants & RFPs</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-slate-700 mb-1">Keyword(s)</label>
          <input id="keywords" type="text" placeholder="e.g. small business, arts, homelessness" class="w-full rounded-md border border-slate-200 p-3" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Location</label>
          <input id="location" type="text" placeholder="e.g. Colorado, USA or Remote" class="w-full rounded-md border border-slate-200 p-3" />
        </div>
        <div class="md:col-span-3 flex gap-3 mt-2">
          <label class="flex items-center gap-2"><input id="eligNonprofit" type="checkbox" /> <span class="text-sm">Nonprofit</span></label>
          <label class="flex items-center gap-2"><input id="eligSmallBiz" type="checkbox" /> <span class="text-sm">Small Business</span></label>
          <label class="flex items-center gap-2"><input id="eligGov" type="checkbox" /> <span class="text-sm">Government</span></label>
          <button id="searchBtn" class="ml-auto bg-indigo-600 text-white px-4 py-2 rounded-md shadow">Search</button>
        </div>
      </div>

      <div id="results" class="mt-4 space-y-3">
        <!-- results will appear here -->
      </div>

      <div class="mt-4 flex gap-3">
        <button id="saveSheetBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-md shadow">Save Selected to Google Sheet</button>
        <button id="emailSheetBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md shadow">Email Sheet to ponder@kencall.org</button>
      </div>

      <div id="sheetInfo" class="mt-3 text-sm text-slate-600"></div>
    </section>

    <!-- Organization + Draft generation -->
    <section class="bg-white rounded-2xl p-6 shadow-sm mb-6">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-xl font-semibold">Generate Drafts (OpenAI)</h2>
          <p class="text-sm text-slate-500">After you approve items in the sheet, generate 5 tailored drafts and email them to ponder@kencall.org</p>
        </div>
        <div class="text-right">
          <button id="genDraftsBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow">Generate 5 Drafts & Email</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-100">
          <h3 class="font-medium mb-2">Organization Info</h3>
          <input id="orgName" placeholder="Organization name" class="w-full rounded-md border p-2 mb-2" />
          <textarea id="orgMission" rows="3" placeholder="Mission (short)" class="w-full rounded-md border p-2 mb-2"></textarea>
          <textarea id="orgProject" rows="3" placeholder="Top program / project" class="w-full rounded-md border p-2 mb-2"></textarea>
          <input id="orgBudget" placeholder="Annual budget (approx)" class="w-full rounded-md border p-2 mb-2" />
        </div>

        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">OpenAI API Key (for draft generation)</label>
          <input id="openaiKey" placeholder="sk-..." class="w-full rounded-md border p-2 mb-3" />
          <div class="text-xs text-slate-500 mb-3">Your key is saved only in this tab's sessionStorage while open. For production, move generation to a backend.</div>
          <div id="draftsContainer" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section class="bg-white rounded-2xl p-6 shadow-sm">
      <h2 class="text-xl font-semibold mb-2">Setup & Notes</h2>
      <ol class="list-decimal pl-5 text-sm space-y-2">
        <li>Create a Google Cloud project and enable <strong>Google Sheets API</strong> and <strong>Gmail API</strong>. Create an <strong>OAuth 2.0 Client ID (Web application)</strong> and set authorized origins to where you'll host this page (or <code>http://localhost</code> for testing).</li>
        <li>Set the <code>GOOGLE_CLIENT_ID</code> and <code>GOOGLE_API_KEY</code> placeholders in this file (see the JS section).</li>
        <li>To generate drafts, paste your OpenAI key into the OpenAI API Key box. For production, host OpenAI calls on a secure server.</li>
      </ol>
    </section>

  </main>

  <footer class="max-w-6xl mx-auto px-6 py-6 text-sm text-slate-500">
    <div class="flex items-center justify-between">
      <div>Built as an MVP • <span id="today"></span></div>
      <div>Emails will be sent to: <strong>ponder@kencall.org</strong></div>
    </div>
  </footer>

  <script>
/* ========================
   CONFIG - replace these
   ========================
   1) GOOGLE_CLIENT_ID: Obtain from Google Cloud Console OAuth 2.0 Client IDs (Web app)
   2) GOOGLE_API_KEY: Obtain from Google Cloud Console (API Key)
   IMPORTANT: For testing locally, set the OAuth authorized origin to http://localhost
*/
const GOOGLE_CLIENT_ID = 'REPLACE_WITH_YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'REPLACE_WITH_YOUR_GOOGLE_API_KEY';

/* Scopes we need: sheets + gmail send + basic profile */
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email openid profile';

/* Default recipient (your email) */
const RECIPIENT_EMAIL = 'ponder@kencall.org';

document.getElementById('today').textContent = new Date().toLocaleDateString();

/* --- Sample mock search dataset (you'll replace / expand with real scrapers or APIs later) --- */
const sampleOpportunities = [
  {id:1, title:'Community Arts Grant — City Foundation', summary:'Supports local arts projects under $20k. Deadline: 30 days', amount:'$5,000 - $20,000'},
  {id:2, title:'Small Business Recovery Fund — State Dept', summary:'Grants for small biz digital upgrades. Deadline: 45 days', amount:'$10,000 - $50,000'},
  {id:3, title:'Youth Services RFP — Regional Health Board', summary:'Funding for youth outreach programs. Deadline: 60 days', amount:'$20,000'},
  {id:4, title:'Housing Stability Grant — Private Funder', summary:'One-year support for eviction prevention. Deadline: 20 days', amount:'$15,000'},
  {id:5, title:'STEM Education Grant — TechCorp', summary:'Supports after-school STEM programs. Deadline: 90 days', amount:'$25,000'}
];

let gapiInited = false;
let gisInited = false;
let isSignedIn = false;

/* Load and initialize Google API client */
function gapiLoadAndInit(){
  gapi.load('client:auth2', async () => {
    try {
      await gapi.client.init({
        apiKey: GOOGLE_API_KEY,
        clientId: GOOGLE_CLIENT_ID,
        discoveryDocs: [
          'https://sheets.googleapis.com/$discovery/rest?version=v4',
          'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
        ],
        scope: SCOPES
      });
      gapiInited = true;
      updateSignInStatus();
    } catch (err) {
      console.error('gapi init error', err);
      alert('Google API init failed. Make sure you set GOOGLE_CLIENT_ID and GOOGLE_API_KEY correctly and enabled APIs in Google Cloud Console.');
    }
  });
}

/* Update UI sign-in state */
function updateSignInStatus(){
  const auth = gapi.auth2.getAuthInstance();
  if(!auth) return;
  isSignedIn = auth.isSignedIn.get();
  document.getElementById('gSignBtn').classList.toggle('hidden', isSignedIn);
  document.getElementById('gSignOutBtn').classList.toggle('hidden', !isSignedIn);
}

/* Sign in / sign out handlers */
document.getElementById('gSignBtn').addEventListener('click', async () => {
  if(!gapiInited){ alert('Google API not ready.'); return; }
  try {
    await gapi.auth2.getAuthInstance().signIn();
    updateSignInStatus();
    alert('Signed in to Google. You can now create Sheets and send email.');
  } catch(e) { console.error(e); alert('Google sign-in failed'); }
});
document.getElementById('gSignOutBtn').addEventListener('click', async () => {
  await gapi.auth2.getAuthInstance().signOut();
  updateSignInStatus();
});

/* Wait for Google API to load */
window.onload = () => {
  // Poll until gapi loaded
  const tryInit = () => {
    if(window.gapi){
      gapiLoadAndInit();
    } else {
      setTimeout(tryInit, 250);
    }
  };
  tryInit();
};

/* ---------- UI: render search results ---------- */
function renderResults(list){
  const container = document.getElementById('results');
  container.innerHTML = '';
  if(!list || !list.length){
    container.innerHTML = '<div class="text-sm text-slate-500">No results yet — try keywords and click Search.</div>';
    return;
  }
  list.forEach(op=>{
    const el = document.createElement('div');
    el.className = 'border rounded-lg p-3 bg-white flex items-start gap-4';
    el.innerHTML = `
      <div class="flex-1">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">${op.title}</h3>
          <div class="text-xs text-slate-500">ID: ${op.id}</div>
        </div>
        <p class="text-sm text-slate-600 mt-1">${op.summary}</p>
        <div class="text-xs text-slate-500 mt-1">Amount: ${op.amount || '-'}</div>
      </div>
      <div class="flex flex-col gap-2">
        <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="select-item" data-id="${op.id}" /> Approve</label>
        <button class="view-opportunity inline-block border px-3 py-1 rounded text-sm" data-id="${op.id}">View</button>
      </div>
    `;
    container.appendChild(el);
  });
}

document.getElementById('searchBtn').addEventListener('click', ()=>{
  const kw = document.getElementById('keywords').value.trim().toLowerCase();
  if(!kw){ renderResults(sampleOpportunities); return; }
  const filtered = sampleOpportunities.filter(o => (o.title + ' ' + o.summary + ' ' + (o.amount||'')).toLowerCase().includes(kw));
  renderResults(filtered);
});

/* ---------- Create Google Sheet and write selected rows ---------- */
async function createSheetWithRows(rows){
  if(!gapiInited || !gapi.client) { alert('Google API not initialized.'); return null; }
  const resource = {
    properties: { title: `GrantFinder Results ${new Date().toLocaleString()}` },
    sheets: [{ properties: { title: 'Opportunities' } }]
  };
  const createResp = await gapi.client.sheets.spreadsheets.create({}, resource);
  const spreadsheetId = createResp.result.spreadsheetId;
  // Prepare values with header
  const values = [
    ['ID','Title','Summary','Amount','Approved']
  ].concat(rows.map(r => [r.id, r.title, r.summary, r.amount || '', r.approved ? 'YES' : '']));
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId,
    range: 'Opportunities!A1:E' + (values.length),
    valueInputOption: 'RAW',
    resource: { values }
  });
  const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
  return { spreadsheetId, spreadsheetUrl };
}

document.getElementById('saveSheetBtn').addEventListener('click', async ()=>{
  // gather selected items
  const checkboxes = Array.from(document.querySelectorAll('.select-item'));
  const selectedIds = checkboxes.filter(c => c.checked).map(c => Number(c.dataset.id));
  if(!selectedIds.length){ alert('No items selected. Please check the Approve box for each item you want to save.'); return; }
  const rows = sampleOpportunities.filter(o => selectedIds.includes(o.id)).map(o => ({...o, approved:true}));
  try {
    const resp = await createSheetWithRows(rows);
    document.getElementById('sheetInfo').innerHTML = `Sheet created: <a href="${resp.spreadsheetUrl}" target="_blank" class="text-blue-600 underline">${resp.spreadsheetUrl}</a>`;
    // store last created spreadsheetId in session for later emailing
    sessionStorage.setItem('lastSpreadsheetId', resp.spreadsheetId);
  } catch(e){
    console.error(e);
    alert('Failed to create sheet. Check console for details.');
  }
});

/* ---------- Send sheet link via Gmail API (using user's Gmail, via OAuth) ---------- */
async function sendEmail(subject, bodyHtml, attachments){ // attachments not used here, kept for extension
  if(!gapiInited || !gapi.client) { alert('Google API not initialized.'); return; }
  const userId = 'me';
  // Create MIME message
  const boundary = '----=_GrantFinder_' + Date.now();
  const rawLines = [];
  const messageText = bodyHtml;
  const mailParts = [
    `From: "GrantFinder" <${(await gapi.client.oauth2.userinfo.get()).result.email}>`,
    `To: ${RECIPIENT_EMAIL}`,
    `Subject: ${subject}`,
    'MIME-Version: 1.0',
    `Content-Type: text/html; charset="UTF-8"`,
    '',
    messageText
  ];
  const mail = mailParts.join('\r\n');
  // base64url encode
  const encoded = btoa(unescape(encodeURIComponent(mail))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  const sendResp = await gapi.client.gmail.users.messages.send({
    userId,
    resource: { raw: encoded }
  });
  return sendResp;
}

document.getElementById('emailSheetBtn').addEventListener('click', async ()=>{
  const spreadsheetId = sessionStorage.getItem('lastSpreadsheetId');
  if(!spreadsheetId){ alert('No sheet found. Create a sheet first by selecting items and clicking "Save Selected to Google Sheet".'); return; }
  const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
  const subject = 'GrantFinder — Approved Opportunities Sheet';
  const body = `<p>Hello,</p><p>I created a sheet with approved grants/RFPs: <a href="${spreadsheetUrl}">${spreadsheetUrl}</a></p><p>— GrantFinder</p>`;
  try {
    await sendEmail(subject, body);
    alert(`Sheet emailed to ${RECIPIENT_EMAIL}`);
  } catch(e){
    console.error(e);
    alert('Failed to send email via Gmail API. Check console and ensure you granted Gmail send scope.');
  }
});

/* ---------- OpenAI draft generation (client-side using user-provided key) ---------- */
function saveOpenAIKey(key){
  if(!key) return;
  sessionStorage.setItem('openai_key', key);
}
function getOpenAIKey(){ return sessionStorage.getItem('openai_key'); }
document.getElementById('openaiKey').addEventListener('change', (e) => {
  const k = e.target.value.trim();
  if(k) saveOpenAIKey(k);
});
document.getElementById('openaiKey').value = getOpenAIKey() || '';

async function generateDraftText(opportunity, org, openaiKey){
  // Use OpenAI Chat Completion endpoint (client provided key). For production use server-side calls.
  const prompt = `You are a grant writer. Create a concise draft proposal for this opportunity tailored to the organization.
Opportunity Title: ${opportunity.title}
Opportunity Summary: ${opportunity.summary}
Organization Name: ${org.name || '[Organization name]'}
Mission: ${org.mission || '[Mission]'}
Project: ${org.project || '[Project description]'}
Annual Budget: ${org.budget || '[Budget]'}
Requested amount (suggested): ${opportunity.amount || '[suggested amount]'}
Write a ~400-600 word draft with: Executive Summary, Need, Goals & Objectives, Activities, Budget Summary, Contact.`.trim();

  const body = {
    model: 'gpt-4o-mini', // change to the model you prefer / have access to
    messages: [{ role: 'system', content: 'You are an expert grant writer.' }, { role: 'user', content: prompt }],
    max_tokens: 900,
    temperature: 0.2
  };

  const resp = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + openaiKey,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if(!resp.ok){
    const err = await resp.text();
    throw new Error('OpenAI error: ' + err);
  }
  const data = await resp.json();
  const text = data?.choices?.[0]?.message?.content || JSON.stringify(data, null, 2);
  return text;
}

document.getElementById('genDraftsBtn').addEventListener('click', async ()=>{
  // For simplicity: generate drafts from the currently selected/approved sampleOpportunities
  const openaiKey = getOpenAIKey();
  if(!openaiKey){ alert('Please paste your OpenAI API key in the OpenAI API Key box first.'); return; }

  // Get approved items from sheet if we have lastSpreadsheetId -- attempt to read sheet. Otherwise, use selected items in UI.
  const spreadsheetId = sessionStorage.getItem('lastSpreadsheetId');
  let approvedRows = [];
  if(spreadsheetId && gapiInited && gapi.client){
    try {
      const resp = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range: 'Opportunities!A2:E' });
      const vals = resp.result.values || [];
      approvedRows = vals.filter(r => (r[4] || '').toLowerCase().includes('yes')).map(r => ({ id: r[0], title: r[1], summary: r[2], amount: r[3] }));
    } catch(e){
      console.warn('Failed to read sheet, falling back to UI selection', e);
    }
  }
  if(!approvedRows.length){
    // fallback to checkboxes on page
    const checkboxes = Array.from(document.querySelectorAll('.select-item'));
    const selectedIds = checkboxes.filter(c => c.checked).map(c => Number(c.dataset.id));
    if(!selectedIds.length){ alert('No approved items found in sheet or UI. Please mark approvals then try again.'); return; }
    approvedRows = sampleOpportunities.filter(o => selectedIds.includes(o.id));
  }

  // Cap to 5 items (if more than 5 approved, pick first 5)
  approvedRows = approvedRows.slice(0,5);
  const org = {
    name: document.getElementById('orgName').value,
    mission: document.getElementById('orgMission').value,
    project: document.getElementById('orgProject').value,
    budget: document.getElementById('orgBudget').value
  };

  // Clear UI
  const container = document.getElementById('draftsContainer');
  container.innerHTML = '<div class="text-sm text-slate-500">Generating drafts — this may take a minute...</div>';

  try {
    const drafts = [];
    for(let i=0;i<approvedRows.length;i++){
      const op = approvedRows[i];
      const text = await generateDraftText(op, org, openaiKey);
      drafts.push({op, text});
      // show intermediate results
      container.innerHTML = drafts.map((d, idx) => `
        <div class="p-4 bg-slate-50 border rounded-lg">
          <div class="flex items-start justify-between">
            <div>
              <h4 class="font-medium">Draft ${idx+1}: ${d.op.title}</h4>
              <p class="text-sm text-slate-600">Auto-generated.</p>
            </div>
            <div class="flex gap-2">
              <button class="download-draft inline-block border px-3 py-1 rounded text-sm" data-idx="${idx}">Download</button>
            </div>
          </div>
          <pre class="mt-3 text-sm text-slate-700" id="draft-pre-${idx}">${escapeHtml(d.text)}</pre>
        </div>
      `).join('');
    }

    // After generation, email drafts as a single email with drafts attached inline
    let bodyHtml = `<p>Hello,</p><p>Attached are ${drafts.length} generated grant/RFP drafts.</p>`;
    drafts.forEach((d, idx) => {
      bodyHtml += `<hr/><h3>Draft ${idx+1}: ${d.op.title}</h3><pre style="white-space:pre-wrap;">${escapeHtml(d.text)}</pre>`;
    });
    bodyHtml += `<p>— GrantFinder</p>`;

    await sendEmail('GrantFinder — Generated Drafts', bodyHtml);
    alert(`Generated ${drafts.length} drafts and emailed to ${RECIPIENT_EMAIL}`);
  } catch(e){
    console.error(e);
    alert('Draft generation or emailing failed. Check console for details.');
  }
});

/* ---------- Small helpers ---------- */
function escapeHtml(s){
  return s ? s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') : '';
}

/* Event delegation for download buttons (draft downloads) */
document.addEventListener('click', (e)=>{
  if(e.target.matches('.download-draft')){
    const idx = e.target.dataset.idx;
    const pre = document.getElementById('draft-pre-' + idx);
    if(!pre) return;
    const text = pre.textContent;
    const filename = `draft-${Number(idx)+1}.txt`;
    downloadTextFile(text, filename);
  }
});

function downloadTextFile(text, filename){
  const blob = new Blob([text], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
}
  </script>
</body>
</html>
